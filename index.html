<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kennzeichensuche</title>

  <!-- Manifest & App-Infos -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#121212" />
  <meta name="description" content="Offlinef√§hige Kennzeichen-App mit Favoriten und Verlauf." />
  
  <!-- Icons -->
  <link rel="icon" href="icons/icon.png" type="image/png" />
  <link rel="apple-touch-icon" href="icons/icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Styles -->
  <style>
  /* --- Intro / Splash --- */
.intro {
  position: fixed; inset: 0; z-index: 10000;
  display: grid; place-items: center;
  background:
    radial-gradient(900px 600px at 100% -10%, rgba(91,140,255,.22), transparent 60%),
    radial-gradient(800px 480px at -10% 110%, rgba(142,240,191,.16), transparent 60%),
    var(--bg);
  color: var(--text);
}
.intro.hide { animation: introFadeOut .5s ease forwards; }

.intro-card{
  display:grid; place-items:center; gap:.7rem;
  padding:2rem 2.4rem; border-radius:18px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow);
  text-align:center;
  animation: introPop .7s cubic-bezier(.2,.7,.2,1) both;
}
.intro-logo{
  width:64px; height:64px; border-radius:14px; color:#fff; font-weight:800; font-size:1.25rem;
  display:grid; place-items:center;
  background: linear-gradient(135deg, var(--primary), #7aa4ff);
  box-shadow: 0 12px 22px rgba(91,140,255,.35), inset 0 1px 1px rgba(255,255,255,.25);
}
.intro-title{ font-weight:800; letter-spacing:.2px; }
.intro-sub{ color: var(--muted); font-size:.95rem; }

/* Animationen */
@keyframes introPop {
  from { transform: translateY(8px) scale(.94); opacity:0 }
  to   { transform:none; opacity:1 }
}
@keyframes introFadeOut {
  to { opacity:0; transform: translateY(-8px); visibility:hidden }
}

/* Barrierefreiheit: weniger Bewegung respektieren */
@media (prefers-reduced-motion: reduce) {
  .intro, .intro-card { animation:none !important }
}
    /* Spinner (Overlay) */
.spinner {
  position: fixed; inset: 0; display: none; place-items: center;
  background: rgba(0,0,0,.25); backdrop-filter: blur(2px); z-index: 9999;
}
.spinner .dot {
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--primary);
  box-shadow: 0 0 0 4px rgba(91,140,255,.25);
  animation: pulse 1.1s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { transform: scale(0.9); opacity: .6; }
  50%      { transform: scale(1.25); opacity: 1; }
}

/* Fade-in f√ºr Karten/Vorschl√§ge */
.fade-in { animation: fadeIn .28s ease-out both; }
@keyframes fadeIn { from { opacity:0; transform: translateY(4px) } to { opacity:1; transform:none } }

/* Dezente Hover-/Focus-Transitions verfeinern */
.card, #search, .btn { transition: border-color .2s, box-shadow .2s, transform .12s; }
.card:hover { transform: translateY(-1px); }
    :root{
      --bg:#0b1020; --bg-soft:#111733; --card:#0f1733; --text:#e9ecf5; --muted:#a7b0c6;
      --primary:#5b8cff; --accent:#8ef0bf; --ring:rgba(139,172,255,.35);
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fc; --bg-soft:#fff; --card:#fff; --text:#0d1220; --muted:#6b7280;
        --primary:#3b82f6; --accent:#10b981; --ring:rgba(59,130,246,.25); --shadow:0 10px 25px rgba(15,23,42,.08); }
    }
    body.light{ --bg:#f6f8fc; --bg-soft:#fff; --card:#fff; --text:#0d1220; --muted:#6b7280;
      --primary:#3b82f6; --accent:#10b981; --ring:rgba(59,130,246,.25); --shadow:0 10px 25px rgba(15,23,42,.08); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 700px at 100% -10%, rgba(91,140,255,.25), transparent 60%),
        radial-gradient(900px 600px at -10% 110%, rgba(142,240,191,.18), transparent 60%),
        var(--bg);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; line-height:1.45;
    }
    .container{max-width:900px;margin:0 auto;padding:24px}
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;}
    .brand{display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow);}
    .brand .logo{width:36px;height:36px;border-radius:10px; display:grid;place-items:center;color:#fff;font-weight:800;
      background: linear-gradient(135deg,var(--primary),#7aa4ff); box-shadow: 0 10px 18px rgba(91,140,255,.35), inset 0 1px 1px rgba(255,255,255,.25);}
    .brand strong{font-size:1.05rem}
    .toolbar{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.1); color:var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding:.55rem .85rem; border-radius:12px; cursor:pointer; box-shadow:var(--shadow);}
    .btn:hover{border-color:var(--ring)}
    .btn.primary{background:linear-gradient(180deg, rgba(91,140,255,.25), rgba(91,140,255,.15)); border-color:var(--ring)}

    .searchWrap{position:relative; margin:10px 0 16px;}
    #search{width:100%; padding:14px 16px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--text); outline:none; box-shadow:var(--shadow);}
    #search:focus{border-color:var(--ring); box-shadow:0 0 0 4px var(--ring)}
    #results{display:grid; gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); border-radius:var(--radius); padding:14px 16px;
      box-shadow:var(--shadow); backdrop-filter: blur(4px);}
    .topRow{display:flex;align-items:center; justify-content:space-between; gap:12px}
    .code{font-size:1.05rem; font-weight:800; letter-spacing:.5px; padding:.25rem .6rem; border-radius:10px; color:#0b1020;
      background: linear-gradient(135deg,#fff,#ebefff); box-shadow:inset 0 1px 0 rgba(0,0,0,.05), 0 6px 14px rgba(91,140,255,.25);}
    .badge{display:inline-flex; align-items:center; gap:.35rem; font-size:.78rem; padding:.25rem .55rem; border-radius:999px;
      background:rgba(91,140,255,.15); color:#dbe7ff; border:1px solid rgba(91,140,255,.25);}
    .flag{font-size:1rem}
    .muted{color:var(--muted)}
    .link{margin-top:.4rem; display:inline-block}
    .link a{color:var(--accent); text-decoration:none}
    .link a:hover{text-decoration:underline}
    .icon-btn{background:none; border:none; cursor:pointer; font-size:1.1rem; color:#ffd56a}
    .icon-btn.fav{filter: drop-shadow(0 3px 6px rgba(255,213,106,.35))}
    .pill{display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .65rem; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); margin:.25rem .35rem .25rem 0; box-shadow:var(--shadow);}
    .pill .code{background:transparent; color:inherit; box-shadow:none; padding:0; font-size:.9rem}
    /* Vorschlagsliste unter dem Suchfeld */
#suggestions { position: relative; }
#suggestions .list{
  position:absolute; top:6px; left:0; right:0; z-index:30;
  background:var(--bg-soft); border:1px solid rgba(255,255,255,.12);
  border-radius:14px; overflow:hidden; box-shadow:var(--shadow);
  backdrop-filter: blur(6px);
}
.sug{ padding:.75rem 1rem; cursor:pointer; }
.sug:hover,.sug.active{ background:rgba(255,255,255,.06); }

/* Markierung der Treffer im Text */
.hl{
  background:rgba(255,255,0,.35);
  border-radius:3px;
  padding:0 2px;
}
    /* === Fix: Verlauf / Historie Farben im Darkmode === */
.history-entry, .history-entry * {
  color: var(--text) !important;
}

#history .card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: .75rem 1rem;
  margin-bottom: .6rem;
}

#history .card:hover {
  background: rgba(255,255,255,0.08);
  transition: background .2s ease;
}

/* Optional: kleine Schrift f√ºr Zeitangaben etc. */
.history-time {
  color: var(--muted);
  font-size: .85rem;
}
    /* === Fix: Bundesland-Text (Badges) im Darkmode === */
.badge {
  color: var(--text) !important;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 0.15rem 0.5rem;
  font-size: 0.9rem;
  display: inline-block;
  margin-left: .25rem;
}

/* Optional: leichte Variante im Lightmode */
@media (prefers-color-scheme: light) {
  .badge {
    background: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.08);
  }
}
  </style>
</head>

<body>
  <!-- Start-Intro -->
<div id="intro" class="intro" aria-hidden="true">
  <div class="intro-card">
    <div class="intro-logo">KF</div>
    <div class="intro-title">Kennzeichensuche</div>
    <div class="intro-sub">Schnell. Offline. Mit Favoriten.</div>
  </div>
</div>
  <div class="container">
    <!-- Lade-Overlay -->
    <div id="spinner" class="spinner">
      <div class="dot"></div>
    </div>
    <div class="header">
      <div class="brand">
        <div class="logo">KFZ</div>
        <strong>Kennzeichensuche</strong>
      </div>
      <div class="toolbar">
        <button id="themeToggle" class="btn">üåó Theme</button>
        <a class="btn primary" href="https://www.google.com/maps" target="_blank" rel="noopener">Maps</a>
      </div>
    </div>

    <!-- Suche -->
    <div class="searchWrap">
      <input id="search" type="text" placeholder="Kennzeichen, Ort oder Bundesland ‚Ä¶" autocomplete="off">
      <div id="suggestions"></div>
    </div>

    <!-- Ergebnisse + Favoriten + Verlauf -->
    <div id="results"></div>
    <section class="section" style="margin-top:22px">
      <h3>Meine Favoriten ‚≠ê</h3>
      <button id="clearFavs" class="btn" type="button">Favoriten l√∂schen</button>
      <div id="favs" style="margin:.6rem 0 1.1rem;"></div>
    </section>
    <section class="section" style="margin-top:22px">
      <h3>Zuletzt gesucht</h3>
      <button id="clearHistory" class="btn" type="button">Verlauf l√∂schen</button>
      <div id="history" style="margin:.6rem 0;"></div>
    </section>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6"></script>

  <!-- App-Logik -->
  <script>
  const introEl = document.getElementById('intro');
const spinner = document.getElementById('spinner');

function showSpinner(){ if (spinner) spinner.style.display = 'grid'; }
function hideSpinner(){ if (spinner) spinner.style.display = 'none'; }

function showIntro(){ if (introEl) introEl.style.display = 'grid'; }
function hideIntro(){
  if (!introEl) return;
  introEl.classList.add('hide');
  setTimeout(()=> { introEl.style.display = 'none'; }, 500);
}

// Intro / Spinner + Timeout-Logik
const forceIntro = new URL(location.href).searchParams.get('intro') === '1';
const wantIntro  = forceIntro || !localStorage.getItem('kz_intro_done');

// Intro nur beim ersten Mal, sonst sofort Spinner
if (wantIntro) {
  showIntro();
} else {
  showSpinner();
}

let rows = [];
let loading = true;

// Fallback: nach 10s abbrechen und Fehlermeldung zeigen
const loadTimeout = setTimeout(() => {
  if (!loading) return; // schon fertig
  if (wantIntro) {
    hideIntro();
  }
  hideSpinner();
  document.getElementById('results').innerHTML =
    '<p class="muted">‚ùå Die Daten konnten innerhalb von 10&nbsp;Sekunden nicht geladen werden. ' +
    'Bitte deine Internetverbindung pr√ºfen und sp√§ter erneut versuchen.</p>';
}, 10000);

try {
  const resp = await fetch('daten.json');
  if (!resp.ok) throw new Error('HTTP ' + resp.status);

  const data = await resp.json();

  rows = Array.isArray(data)
    ? data
    : (Array.isArray(data.de) ? data.de : Object.values(data));

  // wenn es hier ankommt, war Laden erfolgreich
  localStorage.setItem('kz_intro_done', '1');

} catch (err) {
  console.error(err);
  document.getElementById('results').innerHTML =
    '<p class="muted">‚ùå Fehler beim Laden der Daten. Bitte sp√§ter erneut versuchen.</p>';

} finally {
  // egal ob Erfolg oder Fehler ‚Üí Timeout stoppen und UI freigeben
  loading = false;
  clearTimeout(loadTimeout);

  if (wantIntro) {
    hideIntro();
  }
  hideSpinner();
  }

    const fuse = new Fuse(rows, {
      keys: [
        { name: 'code',  weight: 0.6 },
        { name: 'city',  weight: 0.3 },
        { name: 'state', weight: 0.1 }
      ],
      threshold: 0.3, ignoreLocation: true, minMatchCharLength: 1, includeMatches: true, useExtendedSearch: true
    });
    window.fuse = fuse;

    function debounce(fn, ms=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }
    window.escapeHtml = escapeHtml;

    function highlight(line, matches, item) {
      if (!matches || matches.length === 0) return escapeHtml(line);
      let out = line;
      function markField(fieldName) {
        const m = matches.find(mm => mm.key === fieldName); if (!m) return;
        const ranges = m.indices.slice().sort((a,b)=>b[0]-a[0]);
        let val = String(item[fieldName] ?? '');
        ranges.forEach(([s,e]) => { val = val.slice(0,s) + '<span class="hl">' + escapeHtml(val.slice(s,e+1)) + '</span>' + val.slice(e+1); });
        out = out.replace(String(item[fieldName] ?? ''), val);
      }
      ['code','city','state'].forEach(markField);
      return out;
    }

    let activeIndex = -1;
    function showSuggestions(items) {
      if (!items || items.length === 0 || !input.value.trim()) { suggWrap.innerHTML = ''; activeIndex = -1; return; }
      const list = document.createElement('div'); list.className = 'list'; list.setAttribute('role','listbox');
      items.slice(0,8).forEach((res, i) => {
        const it = res.item || res;
        const div = document.createElement('div'); div.className = 'sug'; div.setAttribute('role','option'); div.dataset.index = i;
        const line = `${it.code}${it.city ? ' ¬∑ '+it.city : ''}${it.state ? ' ¬∑ '+it.state : ''}`;
        div.innerHTML = highlight(line, res.matches || [], it);
        div.addEventListener('mousedown', (e) => { e.preventDefault(); selectSuggestion(it); });
        list.appendChild(div);
      });
      suggWrap.innerHTML = ''; suggWrap.appendChild(list); activeIndex = -1;
      list.classList.add('fade-in');
    }

    function selectSuggestion(item) {
      input.value = [item.code, item.city, item.state].filter(Boolean).join(' ¬∑ ');
      suggWrap.innerHTML = '';
      const final = fuse.search(`^${item.code}`);
      renderResults(final.length ? final : [{item}]);
    }

    const onType = debounce(() => {
      const q = input.value.trim();
      if (!q) { suggWrap.innerHTML=''; resultsEl.innerHTML=''; return; }
      const res = fuse.search(q); showSuggestions(res); renderResults(res);
    }, 140);

    input.addEventListener('input', onType);
    input.addEventListener('focus', onType);
    input.addEventListener('blur', () => setTimeout(()=>suggWrap.innerHTML='', 120));

    document.addEventListener('keydown', (e) => {
      const list = suggWrap.querySelector('.list'); if (!list) return;
      const items = Array.from(list.querySelectorAll('.sug'));
      if (['ArrowDown','ArrowUp','Enter','Escape'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowDown') { activeIndex = Math.min(activeIndex + 1, items.length - 1); items.forEach(el => el.classList.remove('active')); if (items[activeIndex]) items[activeIndex].classList.add('active'); }
      if (e.key === 'ArrowUp')   { activeIndex = Math.max(activeIndex - 1, 0); items.forEach(el => el.classList.remove('active')); if (items[activeIndex]) items[activeIndex].classList.add('active'); }
      if (e.key === 'Enter' && activeIndex >= 0) { items[activeIndex].dispatchEvent(new MouseEvent('mousedown')); }
      if (e.key === 'Escape') { suggWrap.innerHTML = ''; }
    });
  })();

  /* Favoriten + Verlauf */
  const favKey = 'kz_favs_v1';
  const histKey = 'kz_history_v1';
  function readLS(key, def=[]) { try { return JSON.parse(localStorage.getItem(key)) ?? def; } catch { return def; } }
  function writeLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
  function getFavs() { return readLS(favKey); }
  function setFavs(arr) { writeLS(favKey, arr); renderFavs(); }
  function getHistory() { return readLS(histKey); }
  function setHistory(arr) { writeLS(histKey, arr); renderHistory(); }
  function pushHistory(entry) {
    const h = getHistory();
    const id = [entry.code, entry.city, entry.state].filter(Boolean).join('|');
    const filtered = h.filter(x => x.id !== id);
    filtered.unshift({ id, ...entry });
    setHistory(filtered.slice(0, 12));
  }
  function isFav(code) { return getFavs().some(x => x.code === code); }
  function toggleFav(entry) {
    const favs = getFavs();
    const exists = favs.find(x => x.code === entry.code);
    const next = exists ? favs.filter(x => x.code !== entry.code)
                        : [{ code: entry.code, city: entry.city, state: entry.state, flag: entry.flag }, ...favs].slice(0, 50);
    setFavs(next);
  }
  function renderFavs() {
    const favsEl = document.getElementById('favs');
    const favs = getFavs();
    favsEl.innerHTML = favs.length ? favs.map(it => `
      <span class="pill">
        <span class="code">${escapeHtml(it.code)}</span>
        <span class="city">${escapeHtml(it.city||'‚Äî')}</span>
        ${it.state ? `<span class="badge">${escapeHtml(it.state)}</span>` : ''}
        <button class="icon-btn" title="Favorit entfernen" onclick='(function(){toggleFav(${JSON.stringify(it)}); renderFavs(); })()'>‚úñ</button>
      </span>
    `).join('') : '<span class="muted">Noch keine Favoriten.</span>';
  }
  function renderHistory() {
    const histEl = document.getElementById('history');
    const h = getHistory();
    histEl.innerHTML = h.length ? h.map(it => `
      <button class="pill" title="Erneut suchen" onclick='(function(){selectFromHistory(${JSON.stringify(it)});})()'>
        <span class="code">${escapeHtml(it.code)}</span>
        <span class="city">${escapeHtml(it.city||'‚Äî')}</span>
        ${it.state ? `<span class="badge">${escapeHtml(it.state)}</span>` : ''}
      </button>
    `).join('') : '<span class="muted">Noch kein Verlauf.</span>';
  }
  function selectFromHistory(it) {
    const q = [it.code, it.city, it.state].filter(Boolean).join(' ¬∑ ');
    const input = document.getElementById('search');
    input.value = q;
    const res = (window.fuse ? window.fuse.search(q) : []);
    renderResults(res && res.length ? res : [{ item: it }]);
  }

  function renderResults(list) {
    const resultsEl = document.getElementById('results');
    if (!list || list.length === 0) { resultsEl.innerHTML = '<p class="muted">Keine Treffer.</p>'; return; }
    resultsEl.innerHTML = list.map(res => {
      const it = res.item || res;
      const flag = it.flag ? `<span class="flag">${escapeHtml(it.flag)}</span>` : '';
      const state = it.state ? `<span class="badge">${escapeHtml(it.state)}</span>` : '';
      const city = it.city ? escapeHtml(it.city) : '‚Äî';
      const code = escapeHtml(it.code);
      const mapQ = encodeURIComponent(it.city || it.code);
      const favOn = isFav(it.code);
      return `
        <div class="card">
          <div class="topRow">
            <div>
              <div class="meta" style="display:flex;gap:10px;align-items:center;">
                <span class="code">${code}</span>
                ${state} ${flag}
              </div>
              <div class="muted" style="margin-top:.25rem">${city}</div>
            </div>
            <button class="icon-btn ${favOn ? 'fav' : ''}" 
                    title="${favOn ? 'Favorit entfernen' : 'Als Favorit speichern'}"
                    onclick='(function(){
                      toggleFav(${JSON.stringify(it)});
                      const q = document.getElementById("search").value;
                      const res = (window.fuse ? window.fuse.search(q) : []);
                      renderResults(res && res.length ? res : [{ item: ${JSON.stringify(it)} }]);
                    })()'>
              ${favOn ? '‚òÖ' : '‚òÜ'}
            </button>
          </div>
          <div class="link">
            <a target="_blank" rel="noopener" href="https://www.google.com/maps/search/?api=1&query=${mapQ}">
              Auf der Karte zeigen
            </a>
          </div>
        </div>
      `;
    }).join('');
    Array.from(resultsEl.children).forEach(el => el.classList.add('fade-in'));
    
    const first = list[0]?.item || list[0];
    if (first) pushHistory(first);
    renderFavs(); renderHistory();
  }

  // Panels initial
  renderFavs(); renderHistory();
  </script>

  <!-- Theme + Service Worker -->
  <script>
    // Theme speichern
    (function(){
      const key = 'kz_theme';
      const saved = localStorage.getItem(key);
      if (saved === 'light') document.body.classList.add('light');
      document.getElementById('themeToggle')?.addEventListener('click', ()=>{
        document.body.classList.toggle('light');
        localStorage.setItem(key, document.body.classList.contains('light') ? 'light' : 'dark');
      });
    })();

    // Service Worker registrieren
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('‚úÖ Service Worker registriert'))
        .catch(err => console.error('‚ùå Service Worker Fehler:', err));
    }
  </script>
</body>
</html>
